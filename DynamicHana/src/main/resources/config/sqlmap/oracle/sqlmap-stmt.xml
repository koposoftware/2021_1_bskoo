<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="stmt.StmtDAO">
	<resultMap type="stmtVO" id="stmtMap">
		<result column="card_name" property="cardName" />
		<result column="card_code" property="cardCode" />
		<result column="sub_total" property="subTotal" />
		<result column="history_date" property="historyDate" />

	</resultMap>

	<select id="selectCardName" parameterType="String"
		resultType="String">
		SELECT C.CARD_NAME FROM
		MEMBER_CARD M,
		CARD C WHERE
		M.CARD_CODE = C.CARD_CODE AND
		M.CARD_NO=#{cardNo}

	</select>

	<select id="selectCardMainInfo" parameterType="String"
		resultMap="stmtMap">
		SELECT SUM(AMOUNT) AS SUB_TOTAL, COUNT(AMOUNT) AS CNT,
		EXTRACT(MONTH FROM SYSDATE)-1 AS MONTH FROM TRANSACTION_HISTORY WHERE
		CARD_NO = #{cardNo} AND HISTORY_DATE BETWEEN
		TO_CHAR(TRUNC(ADD_MONTHS(SYSDATE+1,-1))-TO_CHAR(SYSDATE,'DD'),'YYYY-MM-DD')
		AND
		TO_CHAR(TRUNC(ADD_MONTHS(SYSDATE,0))-TO_CHAR(SYSDATE,'DD'),'YYYY-MM-DD')

	</select>



	<select id="selectCardMainCategory" parameterType="String"
		resultMap="stmtMap">
		<![CDATA[
		SELECT CATEGORY FROM(
SELECT CATEGORY, COUNT(CATEGORY) AS CNT FROM TRANSACTION_HISTORY WHERE CARD_NO = #{cardNo} AND HISTORY_DATE BETWEEN  TO_CHAR(TRUNC(ADD_MONTHS(SYSDATE+1,-1))-TO_CHAR(SYSDATE,'DD'),'YYYY-MM-DD') AND  TO_CHAR(TRUNC(ADD_MONTHS(SYSDATE,0))-TO_CHAR(SYSDATE,'DD'),'YYYY-MM-DD') GROUP BY CATEGORY ORDER BY CNT DESC) WHERE ROWNUM<=1
]]>
	</select>

	<select id="selectTopFive" parameterType="String"
		resultMap="stmtMap">
		<![CDATA[
		SELECT ROWNUM||'. ' || STORE AS CATEGORY, AMOUNT AS SUB_TOTAL FROM(
SELECT * FROM TRANSACTION_HISTORY WHERE CARD_NO=#{cardNo} AND HISTORY_DATE BETWEEN  TO_CHAR(TRUNC(ADD_MONTHS(SYSDATE+1,-1))-TO_CHAR(SYSDATE,'DD'),'YYYY-MM-DD') AND  TO_CHAR(TRUNC(ADD_MONTHS(SYSDATE,0))-TO_CHAR(SYSDATE,'DD'),'YYYY-MM-DD') ORDER BY AMOUNT DESC) WHERE ROWNUM<=5
]]>
	</select>

	<select id="selectCategoryConsumption" parameterType="String"
		resultMap="stmtMap">
		<![CDATA[
		SELECT CATEGORY, SUM(AMOUNT) AS SUB_TOTAL FROM(
SELECT CATEGORY, AMOUNT FROM TRANSACTION_HISTORY WHERE CARD_NO=#{cardNo} AND HISTORY_DATE BETWEEN  TO_CHAR(TRUNC(ADD_MONTHS(SYSDATE+1,-1))-TO_CHAR(SYSDATE,'DD'),'YYYY-MM-DD') AND  TO_CHAR(TRUNC(ADD_MONTHS(SYSDATE,0))-TO_CHAR(SYSDATE,'DD'),'YYYY-MM-DD')) GROUP BY CATEGORY ORDER BY SUB_TOTAL DESC
]]>
	</select>

	<select id="selectWeeklyConsumption" parameterType="String"
		resultMap="stmtMap">
		<![CDATA[
		SELECT ROWNUM||'주차' AS CATEGORY, SUB_TOTAL FROM (
SELECT WEEK, SUM(AMOUNT) AS SUB_TOTAL FROM (
SELECT TO_CHAR(HISTORY_DATE,'IW') AS WEEK, AMOUNT FROM TRANSACTION_HISTORY WHERE CARD_NO=#{cardNo} AND TO_CHAR(HISTORY_DATE,'IW') BETWEEN  TO_CHAR(TO_DATE(TRUNC(ADD_MONTHS(SYSDATE+1,-1))-TO_CHAR(SYSDATE,'DD'),'YYYY-MM-DD'),'IW') AND TO_CHAR(TO_DATE(TRUNC(ADD_MONTHS(SYSDATE,0))-TO_CHAR(SYSDATE,'DD'),'YYYY-MM-DD'),'IW')) GROUP BY WEEK ORDER BY WEEK)
]]>
	</select>

	<select id="selectMonthlyConsumption" resultMap="stmtMap"
		resultType="list">
		<![CDATA[
		SELECT RN AS NO, HISTORY_DATE, STORE, AMOUNT FROM (SELECT ROWNUM RN,
		A.* FROM
		(SELECT ROWNUM AS NO, HISTORY_DATE, STORE, AMOUNT FROM(
SELECT HISTORY_DATE, STORE, AMOUNT FROM TRANSACTION_HISTORY WHERE CARD_NO=#{cardNo} AND HISTORY_DATE BETWEEN  TO_CHAR(TRUNC(ADD_MONTHS(SYSDATE+1,-1))-TO_CHAR(SYSDATE,'DD'),'YYYY-MM-DD') AND  TO_CHAR(TRUNC(ADD_MONTHS(SYSDATE,0))-TO_CHAR(SYSDATE,'DD'),'YYYY-MM-DD') ORDER BY HISTORY_DATE DESC) ORDER BY
		HISTORY_DATE DESC) A
		)
		WHERE RN
		BETWEEN
		#{start} AND #{end}
]]>
	</select>


	<select id="selectMonthlyLength" parameterType="String"
		resultType="int">
		<![CDATA[
		SELECT COUNT(*) FROM TRANSACTION_HISTORY WHERE CARD_NO=#{cardNo} AND HISTORY_DATE BETWEEN  TO_CHAR(TRUNC(ADD_MONTHS(SYSDATE+1,-1))-TO_CHAR(SYSDATE,'DD'),'YYYY-MM-DD') AND  TO_CHAR(TRUNC(ADD_MONTHS(SYSDATE,0))-TO_CHAR(SYSDATE,'DD'),'YYYY-MM-DD')
]]>
	</select>

	<select id="selectTimeSlot" parameterType="String"
		resultMap="stmtMap">
		<![CDATA[
		SELECT HISTORY_TIME HISTORY_DATE, SUM(SUB_TOTAL) AS
		SUB_TOTAL FROM(
		SELECT T2.HISTORY_TIME, NVL(T1.AMOUNT,0) AS SUB_TOTAL FROM(
		SELECT * FROM TRANSACTION_HISTORY WHERE CARD_NO=#{cardNo} AND
		HISTORY_DATE BETWEEN
		TO_CHAR(TRUNC(ADD_MONTHS(SYSDATE+1,-1))-TO_CHAR(SYSDATE,'DD'),'YYYY-MM-DD')
		AND
		TO_CHAR(TRUNC(ADD_MONTHS(SYSDATE,0))-TO_CHAR(SYSDATE,'DD'),'YYYY-MM-DD')
		ORDER BY HISTORY_TIME) T1,
		(SELECT CASE WHEN LEVEL-1 <=9 THEN '0'||TO_CHAR(LEVEL-1) ELSE
		TO_CHAR(LEVEL-1) END ||':00' AS HISTORY_TIME FROM DUAL CONNECT BY
		LEVEL <=24) T2 WHERE T1. HISTORY_TIME(+) = T2.HISTORY_TIME) GROUP BY
		HISTORY_TIME ORDER BY HISTORY_TIME
		]]>
	</select>

	<select id="selectWeekday" parameterType="String"
		resultMap="stmtMap">
		<![CDATA[
		SELECT HISTORY_DATE, SUM(AMOUNT) AS SUB_TOTAL FROM(
SELECT T1.HISTORY_DATE, NVL(T2.AMOUNT,0) AS AMOUNT FROM(
SELECT CASE LEVEL
    WHEN 1 THEN '일요일'
       WHEN 2 THEN '월요일'
       WHEN 3 THEN '화요일'
       WHEN 4 THEN '수요일'
       WHEN 5 THEN '목요일'
       WHEN 6 THEN '금요일'
       WHEN 7 THEN '토요일'
       END AS HISTORY_DATE FROM DUAL CONNECT BY LEVEL<=7) T1,
(SELECT TO_CHAR(HISTORY_DATE, 'day') AS HISTORY_DATE, AMOUNT FROM TRANSACTION_HISTORY WHERE CARD_NO=#{cardNo} AND HISTORY_DATE BETWEEN  TO_CHAR(TRUNC(ADD_MONTHS(SYSDATE+1,-1))-TO_CHAR(SYSDATE,'DD'),'YYYY-MM-DD') AND  TO_CHAR(TRUNC(ADD_MONTHS(SYSDATE,0))-TO_CHAR(SYSDATE,'DD'),'YYYY-MM-DD')) T2
WHERE T1.HISTORY_DATE = T2.HISTORY_DATE(+)) GROUP BY HISTORY_DATE ORDER BY CASE HISTORY_DATE WHEN '일요일' THEN 1 WHEN '월요일' THEN 2 WHEN '화요일' THEN 3 WHEN '수요일' THEN 4 WHEN '목요일' THEN 5 WHEN '금요일' THEN 6 END
		]]>
	</select>

	<select id="checkPCAMember" parameterType="String"
		resultType="int">
		<![CDATA[
		SELECT COUNT(*) AS CNT FROM PCA_MEMBER WHERE PCA_DATE = TO_CHAR(TRUNC(ADD_MONTHS(SYSDATE+1,-1))-TO_CHAR(SYSDATE,'DD'),'YYYY-MM-DD') AND MEMBER_NO = (SELECT M.MEMBER_NO FROM T_MEMBER T, MEMBER_CARD M WHERE T.MEMBER_NO = M.MEMBER_NO AND M.CARD_NO=#{cardNo})
		]]>
	</select>

	<select id="selectPersonalCategoryPCA" parameterType="String"
		resultMap="stmtMap">
		<![CDATA[
		SELECT T1.CATEGORY FROM PCA_COMPONENT T1,(
SELECT * FROM PCA_MEMBER WHERE PCA_DATE = TO_CHAR(TRUNC(ADD_MONTHS(SYSDATE+1,-1))-TO_CHAR(SYSDATE,'DD'),'YYYY-MM-DD') AND MEMBER_NO = (SELECT M.MEMBER_NO FROM T_MEMBER T, MEMBER_CARD M WHERE T.MEMBER_NO = M.MEMBER_NO AND M.CARD_NO=#{cardNo})) T2
WHERE T1.PCA_DATE = T2.PCA_DATE AND T1.CLUSTER_NO = T2.CLUSTER_NO ORDER BY CATEGORY
		]]>
	</select>

	<select id="selectPersonalCategoryNonePCA"
		parameterType="String" resultMap="stmtMap">
		<![CDATA[
		SELECT CATEGORY FROM(
SELECT CATEGORY, SUM(AMOUNT) AS SUB_TOTAL FROM(
SELECT CATEGORY, AMOUNT FROM TRANSACTION_HISTORY WHERE CARD_NO=#{cardNo} AND HISTORY_DATE BETWEEN TO_CHAR(TRUNC(ADD_MONTHS(SYSDATE+1,-1))-TO_CHAR(SYSDATE,'DD'),'YYYY-MM-DD') AND  TO_CHAR(TRUNC(ADD_MONTHS(SYSDATE,0))-TO_CHAR(SYSDATE,'DD'),'YYYY-MM-DD')) GROUP BY CATEGORY ORDER BY SUB_TOTAL DESC) WHERE ROWNUM<=3 ORDER BY CATEGORY
		]]>
	</select>


	<select id="selectPersonalCategoryConsumptionPCA"
		parameterType="String" resultType="list" resultMap="stmtMap">
		<![CDATA[
		SELECT CATEGORY, CHK, ROUND(AVG(CASE WHEN CHK='my' THEN AMOUNT*1.3 ELSE AMOUNT END),-2) AS AMOUNT FROM(
SELECT CATEGORY, AMOUNT, DECODE(CARD_NO,#{cardNo}, 'my', 'other') AS CHK FROM TRANSACTION_HISTORY WHERE HISTORY_DATE BETWEEN TO_CHAR(TRUNC(ADD_MONTHS(SYSDATE+1,-1))-TO_CHAR(SYSDATE,'DD'),'YYYY-MM-DD') AND  TO_CHAR(TRUNC(ADD_MONTHS(SYSDATE,0))-TO_CHAR(SYSDATE,'DD'),'YYYY-MM-DD') AND CATEGORY IN (SELECT T1.CATEGORY FROM PCA_COMPONENT T1,(
SELECT * FROM PCA_MEMBER WHERE PCA_DATE = TO_CHAR(TRUNC(ADD_MONTHS(SYSDATE+1,-1))-TO_CHAR(SYSDATE,'DD'),'YYYY-MM-DD') AND MEMBER_NO = (SELECT M.MEMBER_NO FROM T_MEMBER T, MEMBER_CARD M WHERE T.MEMBER_NO = M.MEMBER_NO AND M.CARD_NO=#{cardNo})) T2
WHERE T1.PCA_DATE = T2.PCA_DATE AND T1.CLUSTER_NO = T2.CLUSTER_NO)) GROUP BY CATEGORY, CHK ORDER BY CATEGORY
		]]>
	</select>

	<select id="selectPersonalCategoryConsumptionNonePCA"
		parameterType="String" resultType="list" resultMap="stmtMap">
		<![CDATA[
		SELECT CATEGORY, CHK, ROUND(AVG(CASE WHEN CHK='my' THEN AMOUNT*1.3 ELSE AMOUNT END),-2) AS AMOUNT FROM(
SELECT CATEGORY, AMOUNT, DECODE(CARD_NO,#{cardNo}, 'my', 'other') AS CHK FROM TRANSACTION_HISTORY WHERE HISTORY_DATE BETWEEN TO_CHAR(TRUNC(ADD_MONTHS(SYSDATE+1,-1))-TO_CHAR(SYSDATE,'DD'),'YYYY-MM-DD') AND  TO_CHAR(TRUNC(ADD_MONTHS(SYSDATE,0))-TO_CHAR(SYSDATE,'DD'),'YYYY-MM-DD') AND CATEGORY IN (SELECT CATEGORY FROM(
SELECT CATEGORY, SUM(AMOUNT) AS SUB_TOTAL FROM(
SELECT CATEGORY, AMOUNT FROM TRANSACTION_HISTORY WHERE CARD_NO=#{cardNo} AND HISTORY_DATE BETWEEN TO_CHAR(TRUNC(ADD_MONTHS(SYSDATE+1,-1))-TO_CHAR(SYSDATE,'DD'),'YYYY-MM-DD') AND  TO_CHAR(TRUNC(ADD_MONTHS(SYSDATE,0))-TO_CHAR(SYSDATE,'DD'),'YYYY-MM-DD')) GROUP BY CATEGORY ORDER BY SUB_TOTAL DESC) WHERE ROWNUM<=3)) GROUP BY CATEGORY, CHK ORDER BY CATEGORY
		]]>
	</select>

	<select id="selectPersonalCardPCA" parameterType="String"
		resultType="list" resultMap="stmtMap">
		<![CDATA[
		SELECT ROWNUM, CARD_NAME, CARD_CODE FROM(
SELECT ROWNUM,CARD_NAME, CARD_CODE, CNT FROM(
SELECT CARD_NAME, CARD_CODE, COUNT(CARD_NAME) AS CNT FROM(
SELECT N.CARD_NAME, D.CARD_CODE, C.CATEGORY_KOR FROM CARD D, CREDITCARD_NOTICE N, CARD_BENEFITS_CATEGORY C WHERE D.CARD_NAME = N.CARD_NAME AND C.CATEGORY = N.CATEGORY AND
C.CATEGORY_KOR IN (SELECT T1.CATEGORY AS CATEGORY_KOR FROM PCA_COMPONENT T1,(
SELECT * FROM PCA_MEMBER WHERE PCA_DATE = TO_CHAR(TRUNC(ADD_MONTHS(SYSDATE+1,-1))-TO_CHAR(SYSDATE,'DD'),'YYYY-MM-DD') AND MEMBER_NO = (SELECT M.MEMBER_NO FROM T_MEMBER T, MEMBER_CARD M WHERE T.MEMBER_NO = M.MEMBER_NO AND M.CARD_NO=#{cardNo})) T2
WHERE T1.PCA_DATE = T2.PCA_DATE AND T1.CLUSTER_NO = T2.CLUSTER_NO)) GROUP BY CARD_NAME, CARD_CODE) WHERE CNT >=(SELECT COUNT(T1.CATEGORY) AS CATEGORY_KOR FROM PCA_COMPONENT T1,(
SELECT * FROM PCA_MEMBER WHERE PCA_DATE = TO_CHAR(TRUNC(ADD_MONTHS(SYSDATE+1,-1))-TO_CHAR(SYSDATE,'DD'),'YYYY-MM-DD') AND MEMBER_NO = (SELECT M.MEMBER_NO FROM T_MEMBER T, MEMBER_CARD M WHERE T.MEMBER_NO = M.MEMBER_NO AND M.CARD_NO=#{cardNo})) T2
WHERE T1.PCA_DATE = T2.PCA_DATE AND T1.CLUSTER_NO = T2.CLUSTER_NO)) WHERE ROWNUM<=6
		]]>
	</select>
	<select id="selectPersonalCardNonePCA" parameterType="String"
		resultType="list" resultMap="stmtMap">
		<![CDATA[
		SELECT CARD_NAME, CARD_CODE, CNT FROM(
SELECT CARD_NAME, CARD_CODE, COUNT(CARD_CODE) AS CNT FROM(
SELECT N.CARD_NAME, D.CARD_CODE, C.CATEGORY_KOR FROM CARD D, CREDITCARD_NOTICE N, CARD_BENEFITS_CATEGORY C WHERE D.CARD_NAME = N.CARD_NAME AND C.CATEGORY = N.CATEGORY AND
C.CATEGORY_KOR IN (SELECT CATEGORY FROM(
SELECT CATEGORY, SUM(AMOUNT) AS SUB_TOTAL FROM(
SELECT CATEGORY, AMOUNT FROM TRANSACTION_HISTORY WHERE CARD_NO=#{cardNo} AND HISTORY_DATE BETWEEN TO_CHAR(TRUNC(ADD_MONTHS(SYSDATE+1,-1))-TO_CHAR(SYSDATE,'DD'),'YYYY-MM-DD') AND  TO_CHAR(TRUNC(ADD_MONTHS(SYSDATE,0))-TO_CHAR(SYSDATE,'DD'),'YYYY-MM-DD')) GROUP BY CATEGORY ORDER BY SUB_TOTAL DESC) WHERE ROWNUM<=3)) GROUP BY CARD_NAME, CARD_CODE) WHERE CNT>=(SELECT COUNT(CATEGORY) FROM(
SELECT CATEGORY, SUM(AMOUNT) AS SUB_TOTAL FROM(
SELECT CATEGORY, AMOUNT FROM TRANSACTION_HISTORY WHERE CARD_NO=#{cardNo} AND HISTORY_DATE BETWEEN TO_CHAR(TRUNC(ADD_MONTHS(SYSDATE+1,-1))-TO_CHAR(SYSDATE,'DD'),'YYYY-MM-DD') AND  TO_CHAR(TRUNC(ADD_MONTHS(SYSDATE,0))-TO_CHAR(SYSDATE,'DD'),'YYYY-MM-DD')) GROUP BY CATEGORY ORDER BY SUB_TOTAL DESC) WHERE ROWNUM<=3)
		]]>
	</select>



</mapper>